apply plugin: "scala"
apply plugin: 'java'
apply plugin: 'application'
apply plugin: "idea"
apply plugin: "com.github.johnrengelman.shadow"

repositories {
    mavenCentral()
}

dependencies {
    implementation "org.apache.flink:flink-core:1.18.0"
    // flinksql本地运行需要的依赖
    implementation "org.apache.flink:flink-clients:1.18.0"

    implementation "org.apache.flink:flink-java:1.18.0"
    implementation "org.apache.flink:flink-streaming-java:1.18.0"
    implementation "org.apache.flink:flink-scala_2.12:1.18.0"
    implementation "org.apache.flink:flink-streaming-scala_2.12:1.18.0"

    //状态后端管理器
    implementation "org.apache.flink:flink-statebackend-rocksdb:1.18.0"

    //flink本地运行时 提供的web功能
    implementation "org.apache.flink:flink-runtime-web:1.18.0"

    //flink sql
    implementation 'org.apache.flink:flink-table-api-java:1.18.0'
    implementation 'org.apache.flink:flink-table-api-java-bridge:1.18.0'
    implementation "org.apache.flink:flink-table-planner_2.12:1.18.0"
    implementation 'org.apache.flink:flink-sql-gateway-api:1.18.0'

    implementation 'org.apache.flink:flink-cep:1.18.0'
    implementation "org.apache.flink:flink-csv:1.18.0"
    implementation 'org.apache.flink:flink-parquet:1.18.0'
    implementation 'org.apache.parquet:parquet-avro:1.13.1'
    implementation 'org.apache.flink:flink-avro:1.18.0'
    implementation 'org.apache.flink:flink-json:1.18.0'

    //flink连接器
    implementation "org.apache.flink:flink-connector-kafka:3.0.2-1.18"
    implementation 'org.apache.flink:flink-connector-files:1.18.0'
    implementation 'org.apache.flink:flink-connector-hbase-2.2:3.0.0-1.17'
    implementation 'org.apache.doris:flink-doris-connector-1.17:1.5.0-SNAPSHOT'
    implementation 'org.apache.flink:flink-connector-jdbc:3.1.1-1.17'
    implementation 'org.apache.flink:flink-connector-hive_2.12:1.18.0'
    //implementation "org.apache.flink:flink-connector-elasticsearch7:3.0.0-1.16"
    //implementation "org.apache.flink:flink-table-planner-blink_2.12:1.13.6"
    //implementation "org.apache.flink:flink-connector-redis_2.11:1.1.5"
    implementation 'com.ververica:flink-connector-mysql-cdc:3.0.0'
    implementation 'mysql:mysql-connector-java:8.0.33'
    implementation 'redis.clients:jedis:5.1.0'
    implementation 'org.apache.hive:hive-exec:3.1.3'

    implementation 'org.apache.hadoop:hadoop-common:3.3.6'
    implementation 'org.apache.hadoop:hadoop-client:3.3.6'
    implementation 'org.apache.hadoop:hadoop-hdfs:3.3.6'

    implementation 'org.apache.commons:commons-compress:1.25.0'

    implementation("org.apache.hudi:hudi-common:0.14.1")
    implementation("org.apache.hudi:hudi-client:0.14.1")
    implementation("org.apache.hudi:hudi-flink-client:0.14.1")

    implementation 'org.slf4j:slf4j-api:2.0.10'
    implementation 'org.slf4j:slf4j-log4j12:2.0.10'

    implementation "org.scala-lang:scala-library:2.12.18"
    implementation "org.scala-lang:scala-compiler:2.12.18"
    implementation "org.scala-lang:scala-reflect:2.12.18"
}

configurations {
    all {
        resolutionStrategy.cacheChangingModulesFor 0, "seconds"
        resolutionStrategy.cacheDynamicVersionsFor 0, "seconds"

        resolutionStrategy {
            force 'org.glassfish:javax.el:3.0.0'
        }
    }
}

tasks.withType(ScalaCompile) {
    scalaCompileOptions.additionalParameters = ['-unchecked', '-deprecation']
}

jar {
    //详细信息参考 https://docs.gradle.org/current/dsl/org.gradle.api.tasks.bundling.Jar.html
    //archivesBaseName = 'Example'//基本的文件名
    //文件夹大于65535个，需要开启zip64
    //zip64=true

    manifest {
        attributes 'Main-Class': "com.taotao.cloud.bigdata.flink.JStreamWordCount"
    }
    //from sourceSets.main.output
    //dependsOn configurations.runtimeClasspath

    //gradle 处理重复文件，include 最后一个重复文件“胜出”的默认策略。
    //duplicatesStrategy = 'include' // <<---- addition
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE

    //打包依赖包
    //from {
    //    (configurations.runtimeClasspath).collect {
    //        it.isDirectory() ? it : zipTree(it)
    //    }
    //}
    //into('lib') { // 将第三方jar放入 lib目录中
    //    from configurations.compile
    //}
}

task fatJar(type: Jar, dependsOn: jar) {
    zip64=true
    manifest {
        attributes 'Main-Class': "com.taotao.cloud.bigdata.flink.JStreamWordCount"
    }
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE

//    from configurations.runtimeClasspath.filter { !it.path.endsWith('.pom') }.asFileTree.files.collect {
//        zipTree(it)
//    }
}

task customFatJar(type: Jar) {
    manifest {
        attributes 'Main-Class': 'com.taotao.cloud.bigdata.flink.JStreamWordCount'
    }
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    from {
        configurations.runtimeClasspath.filter {
            it.name.endsWith('.jar')
        }
    }
    with jar
}

mainClassName = "com.taotao.cloud.bigdata.flink.JStreamWordCount"
shadowJar {
    zip64 true
    mergeServiceFiles()
    archiveClassifier = null

    //transform(Log4j2PluginsCacheFileTransformer)
    //version = 1.0
    manifest {
        attributes(
                "Main-Class": "com.taotao.cloud.bigdata.flink.JStreamWordCount"
        )
    }

    //dependencies {
    //    exclude(dependency("xml-apis:xml-apis:.*"))
    //    exclude(dependency("xerces:xercesImpl:.*"))
    //    exclude(dependency("org.apache.avro:avro:1.7.*"))
    //    exclude(dependency{ it.moduleGroup == "xml-apis" })
    //}

    // creates the spring boot shaded jar
    //import com.github.jengelman.gradle.plugins.shadow.transformers.PropertiesFileTransformer
    //append 'META-INF/spring.handlers'
    //append 'META-INF/spring.schemas'
    //append 'META-INF/spring.tooling'
    //transform(PropertiesFileTransformer) {
    //    paths = ['META-INF/spring.factories' ]
    //    mergeStrategy = "append"
    //}
    //archiveFileName = "test-${version}.jar"
}

task packageZip(type: Zip) {
    archiveFileName = "${project.name}-${project.version}.zip"
    destinationDirectory = file("${project.buildDir}/result")

    from("${project.projectDir}/distribution") {
        into "distribution"
    }

    from("${project.buildDir}/libs/${project.name}-${project.version}.jar") {
        into "targert"
    }

    dependsOn customFatJar
}


apply plugin: "scala"
apply plugin: "com.github.johnrengelman.shadow"

//import com.github.jengelman.gradle.plugins.shadow.transformers.Log4j2PluginsCacheFileTransformer

repositories {
    mavenCentral()
}

dependencies {
    implementation "com.alibaba.fastjson2:fastjson2:2.0.45"
    implementation "com.alibaba.fastjson2:fastjson2-extension-spring6:2.0.45"

    implementation("org.apache.spark:spark-core_2.13:3.5.0")
    implementation("org.apache.spark:spark-catalyst_2.13:3.5.0")
    implementation("org.apache.spark:spark-graphx_2.13:3.5.0")
    implementation("org.apache.spark:spark-sql_2.13:3.5.0") {
        exclude group: "org.codehaus.janino", module: "janino"
    }
    implementation("org.apache.spark:spark-streaming_2.13:3.5.0")
    implementation("org.apache.spark:spark-mllib_2.13:3.5.0")
    implementation("org.apache.spark:spark-hive_2.13:3.5.0")
    implementation("org.apache.spark:spark-avro_2.13:3.5.0")
    implementation("org.apache.spark:spark-streaming-kafka-0-10_2.13:3.5.0")
    implementation("org.apache.spark:spark-sql-kafka-0-10_2.13:3.5.0")

    implementation "org.elasticsearch:elasticsearch-spark-30_2.13:8.10.2"

    implementation("org.apache.hudi:hudi-common:0.14.0")
    implementation("org.apache.hudi:hudi-client:0.14.0")
    implementation("org.apache.hudi:hudi-hadoop-mr-bundle:0.14.0")
    implementation("org.apache.hudi:hudi-spark3.3-bundle_2.12:0.14.0")

    implementation("org.apache.hadoop:hadoop-common:3.3.6")
    implementation("org.apache.hadoop:hadoop-client:3.3.6")
    implementation("org.apache.hadoop:hadoop-hdfs:3.3.6")

    implementation("org.apache.hive:hive-common:3.1.3")
    implementation("org.apache.hive:hive-metastore:3.1.3") {
        exclude group: "ch.qos.logback", module: "logback-core"
        exclude group: "ch.qos.logback", module: "logback-classic"
        exclude group: "org.apache.logging.log4j", module: "log4j-slf4j-impl"
    }
    implementation("org.apache.hive:hive-jdbc:3.1.3") {
        exclude group: "org.eclipse.jetty.aggregate", module: "*"
        exclude group: "com.google.guava", module: "guava"
        exclude group: "log4j", module: "log4j"
    }

    implementation "com.mysql:mysql-connector-j"
    implementation "commons-codec:commons-codec:1.16.0"

    implementation("com.github.scopt:scopt_2.13:4.1.0") {
        exclude group: "org.scala-lang", module: "scala-library"
        exclude group: "com.google.guava", module: "guava"
    }

    implementation "com.google.guava:guava"
    implementation "org.codehaus.janino:janino:3.1.9"

    implementation "org.scala-lang:scala-library:2.12.18"
    implementation "org.scala-lang:scala-compiler:2.12.18"
    implementation "org.scala-lang:scala-reflect:2.12.18"

    implementation "com.alibaba.fastjson2:fastjson2:2.0.45"
}

configurations {
    all {
        resolutionStrategy.cacheChangingModulesFor 0, "seconds"
        resolutionStrategy.cacheDynamicVersionsFor 0, "seconds"

        resolutionStrategy {
            force "org.apache.avro:avro:1.11.2"
            force "com.google.guava:guava:33.0.0-jre"
            force "org.codehaus.janino:janino:3.1.10"
            force "org.apache.spark:spark-core_2.12:3.4.1"
        }

        exclude group: "xml-apis", module: "xml-apis"
        exclude group: "org.apache.avro", module: "avro-mapred"
        exclude group: "xerces", module: "xercesImpl"
        exclude group: "ch.qos.logback", module: "logback-core"
        exclude group: "ch.qos.logback", module: "logback-classic"
        exclude group: "org.apache.logging.log4j", module: "log4j-slf4j-impl"
    }
}

//mainClassName = "com.taotao.cloud.bigdata.hudi.TaoTaoCloudLogHudi"

jar {
    manifest {
        attributes 'Main-Class': "com.taotao.cloud.bigdata.hudi.TaoTaoCloudLogHudi"
    }
    from sourceSets.main.output
    dependsOn configurations.runtimeClasspath
}

shadowJar {
    mergeServiceFiles()
    archiveClassifier = null

    //transform(Log4j2PluginsCacheFileTransformer)
    //version = 1.0
    manifest {
        attributes(
                "Main-Class": "com.taotao.cloud.bigdata.hudi.TaoTaoCloudLogHudi"
        )
    }
    zip64 true
    //dependencies {
    //    exclude(dependency("xml-apis:xml-apis:.*"))
    //    exclude(dependency("xerces:xercesImpl:.*"))
    //    exclude(dependency("org.apache.avro:avro:1.7.*"))
    //    exclude(dependency{ it.moduleGroup == "xml-apis" })
    //}
}

repositories {
    mavenCentral()
}

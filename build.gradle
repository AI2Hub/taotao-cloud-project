/*
 * Copyright (c) 2020-2030, Shuigedeng (981376577@qq.com & https://blog.taotaocloud.top/).
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
buildscript {
    ext {
        taotaoCloudVersion = version
        taotaoCloudGroup = "io.github.shuigedeng"

        //https://search.maven.org/artifact/org.springframework/spring
        springVersion = '5.3.22'
        //https://search.maven.org/artifact/org.springframework.boot/spring-boot-dependencies
        springBootVersion = '2.7.2'
        //https://search.maven.org/artifact/org.springframework.cloud/spring-cloud-dependencies
        springCloudVersion = '2021.0.3'
        //https://search.maven.org/artifact/com.alibaba.cloud/spring-cloud-alibaba-dependencies
        springCloudAlibabaVersion = '2021.0.1.0'

        //https://search.maven.org/artifact/org.springframework.security/spring-security-core
        springSecurityVersion = '5.6.6'
        //https://search.maven.org/artifact/org.springframework.data/spring-data-commons
        springDataCommonsVersion = '2.7.2'
        //https://search.maven.org/artifact/org.springframework.kafka/spring-kafka
        springKafkaVersion = '2.8.8'

        //https://search.maven.org/artifact/com.fasterxml.jackson.core/jackson-databind
        fasterxmlVersion = '2.13.3'
        //https://search.maven.org/artifact/com.fasterxml.jackson.datatype/jackson-datatype-jsr310
        jacksonDatatypeJsr310Version = '2.13.3'
        //https://search.maven.org/artifact/com.alibaba/transmittable-thread-local
        transmittableVersion = '2.13.2'
        //https://search.maven.org/artifact/org.slf4j/slf4j-api
        slf4jVersion = '1.7.36'
        //https://search.maven.org/artifact/cn.afterturn/easypoi-base
        easypoiVersion = '4.4.0'
        //https://search.maven.org/artifact/org.aspectj/aspectjweaver
        aspectjweaverVersion = '1.9.9.1'
        //https://search.maven.org/artifact/io.projectreactor/reactor-core
        reactorVersion = '3.4.21'
        //https://search.maven.org/artifact/javax.servlet/javax.servlet-api
        servletApiVersion = '4.0.1'
        //https://search.maven.org/artifact/com.nepxion/banner
        bannerVersion = "1.0.2"
        //https://search.maven.org/artifact/org.javassist/javassist
        javassistVersion = '3.29.0-GA'
        //https://search.maven.org/artifact/com.github.whvcse/easy-captcha
        easyCaptchaVersion = '1.6.2'
        //https://search.maven.org/artifact/cn.hutool/hutool-all
        hutoolVersion = '5.8.4'
        //https://search.maven.org/artifact/javax.validation/validation-api
        validationApiVersion = '2.0.1.Final'
        //https://search.maven.org/artifact/com.querydsl/querydsl-apt
        querydslVersion = '5.0.0'
        //https://search.maven.org/artifact/p6spy/p6spy
        p6spyVersion = '3.9.1'
        //https://search.maven.org/artifact/mysql/mysql-connector-java
        mysqlVersion = '8.0.29'
        //https://search.maven.org/artifact/com.baomidou/mybatis-plus-boot-starter
        mybatisPlusStarterVersion = '3.5.2'
        //https://search.maven.org/artifact/com.baomidou/dynamic-datasource-spring-boot-starter
        mybatisPlusDynamicDatasourceStarterVersion = '3.5.1'
        //https://search.maven.org/artifact/com.upyun/java-sdk
        upyunJavaSdkVersion = '4.2.3'
        //https://search.maven.org/artifact/com.aliyun.oss/aliyun-sdk-oss
        aliyunSdkOssVersion = '3.15.1'
        //https://search.maven.org/artifact/com.qiniu/qiniu-java-sdk
        qiniuJavaSdkVersion = '7.11.0'
        //https://search.maven.org/artifact/com.google.code.gson/gson
        gsonVersion = '2.9.0'
        //https://search.maven.org/artifact/com.google.guava/guava
        guavaVersion = '31.1-jre'
        //https://search.maven.org/artifact/com.squareup.okhttp3/okhttp
        okhttpVersion = '4.10.0'
        //https://search.maven.org/artifact/com.squareup.okio/okio
        okioVersion = '3.2.0'
        //https://search.maven.org/artifact/com.github.tobato/fastdfs-client
        fastdfsClientVersion = '1.27.2'
        //https://search.maven.org/artifact/commons-net/commons-net
        commonsNetVersion = '3.8.0'
        //https://search.maven.org/artifact/io.github.openfeign/feign-okhttp
        feignOkhttpVersion = '11.9.1'
        //https://search.maven.org/artifact/org.apache.httpcomponents/httpclient
        httpcomponentsVersion = '4.5.13'
        //https://search.maven.org/artifact/com.github.danielwegener/logback-kafka-appender
        logbackKafkaAppenderVersion = '0.2.0-RC2'
        //https://search.maven.org/artifact/net.logstash.logback/logstash-logback-encoder
        logstashLogbackEncoderVersion = '7.2'
        //https://search.maven.org/artifact/org.apache.commons/commons-lang3
        commonsVersion = '3.12.0'
        //https://search.maven.org/artifact/commons-io/commons-io
        commonsIoVersion = '2.11.0'
        //https://search.maven.org/artifact/commons-collections/commons-collections
        commonsCollectionsVersion = '3.2.2'
        //https://search.maven.org/artifact/org.apache.commons/commons-collections4
        commonsCollections4Version = '4.4'
        //https://search.maven.org/artifact/io.lettuce/lettuce-core
        lettuceVersion = '6.2.0.RELEASE'
        //https://search.maven.org/artifact/org.redisson/redisson-spring-boot-starter
        redissonVersion = "3.17.5"
        //https://search.maven.org/artifact/io.seata/seata-all
        seataVersion = "1.5.2"
        //https://search.maven.org/artifact/org.apache.shardingsphere/sharding-jdbc-spring-namespace
        shardingsphereVersion = "4.1.1"

        //https://search.maven.org/artifact/io.springfox/springfox-swagger2
        swaggerVersion = '3.0.0'
        //https://search.maven.org/artifact/io.swagger.core.v3/swagger-models
        swaggerModelsVersion = '2.2.2'
        //https://search.maven.org/artifact/com.github.xiaoymin/knife4j-spring-ui
        knife4jVersion = '3.0.3'

        //https://search.maven.org/artifact/com.github.qcloudsms/qcloudsms
        qcloudsmsVersion = '1.0.6'
        //https://search.maven.org/artifact/eu.bitwalker/UserAgentUtils
        userAgentUtilsVersion = '1.21'
        //https://search.maven.org/artifact/com.xuxueli/xxl-job-core
        xxlJobVersion = '2.3.1'
        //https://search.maven.org/artifact/org.mapstruct/mapstruct
        mapstructVersion = "1.5.2.Final"
        //https://search.maven.org/artifact/com.alibaba.fastjson2/fastjson2
        fastjsonVersion = "2.0.10"
        //https://search.maven.org/artifact/com.caucho/hessian
        hessianVersion = "4.0.66"
        //https://search.maven.org/artifact/com.esotericsoftware/kryo
        kryoVersion = "5.3.0"
        //https://search.maven.org/artifact/org.openjdk.nashorn/nashorn-core
        nashornVersion = "15.4"
        //https://search.maven.org/artifact/com.google.zxing/javase
        zxingJavaseVersion = "3.5.0"
        //https://search.maven.org/artifact/org.jsoup/jsoup
        jsoupVersion = "1.15.2"
        //https://search.maven.org/artifact/com.thoughtworks.xstream/xstream
        xstreamVersion = "1.4.19"
        //https://search.maven.org/artifact/commons-configuration/commons-configuration
        commonsConfigurationVersion = "1.10"
        //https://search.maven.org/artifact/com.squareup.okhttp3/logging-interceptor
        okhttpLoggingInterceptorVersion = "4.10.0"
        //https://search.maven.org/artifact/com.baomidou/mybatis-plus-core
        mybatisPlusVersion = "3.5.2"
        //https://search.maven.org/artifact/com.github.xkzhangsan/xk-time
        xkTimeVersion = "3.2.3"
        //https://search.maven.org/artifact/cn.afterturn/easypoi-base
        easypoiVersion = "4.4.0"
        //https://search.maven.org/artifact/com.taobao.arthas/arthas-spring-boot-starter
        arthasVersion = "3.6.3"
        //https://search.maven.org/artifact/de.codecentric/spring-boot-admin-starter-server
        adminVersion = "2.7.3"
        //https://search.maven.org/artifact/com.github.ulisesbocchio/jasypt-spring-boot-starter
        jasyptVersion = "3.0.4"
        //https://search.maven.org/artifact/io.github.lyh200/dynamic-tp-spring-cloud-starter-nacos
        dynamicTpVersion = "1.0.7"
        //https://search.maven.org/artifact/joda-time/joda-time
        jodaTimeVersion = "2.10.14"
        //https://search.maven.org/artifact/org.anarres.lzo/lzo-core
        lzoVersion = "1.0.6"
        //https://search.maven.org/artifact/net.jpountz.lz4/lz4
        lz4Version = "1.3.0"
        //https://search.maven.org/artifact/org.xerial.snappy/snappy-java
        snappyVersion = "1.1.8.4"
        //https://search.maven.org/artifact/com.github.pagehelper/pagehelper
        pagehelperVersion = "5.3.1"
        //https://search.maven.org/artifact/org.glassfish.jaxb/jaxb-runtime
        jaxbVersion = "4.0.0"
        //https://search.maven.org/artifact/com.lmax/disruptor
        disruptorVersion = "3.4.4"
        //https://search.maven.org/artifact/org.apache.shardingsphere.elasticjob/elasticjob-lite-spring-boot-starter
        elasticjobVersion = "3.0.1"
        //https://search.maven.org/artifact/org.apache.skywalking/apm-toolkit-trace
        skywalkingVersion = "8.11.0"
        //https://search.maven.org/artifact/com.github.danielwegener/logback-kafka-appender
        logbackKafkaAppenderVersion = "0.2.0-RC2"

        //如果url不指定的话
        //Mac默认：url = https://index.docker.io/v1/
        //Unix默认: url = unix:///var/run/docker.sock
        //Windows默认: url = tcp://127.0.0.1:2375
        set('dockerUrl', "https://index.docker.io/v1/")
        set('dockerUsername', "shuigedeng")
        set('dockerPassword', "xxxxx")
        set('dockerEmail', "981376577@qq.com")
        set('dockerBaseImage', "openjdk:17")
        set('dockerMaintainer', "shuigedeng (https://github.com/shuigedeng)")
    }

    repositories {
        mavenLocal()
        maven { url "https://plugins.gradle.org/m2/" }

        maven {
            allowInsecureProtocol = true
            url "https://maven.aliyun.com/nexus/content/groups/public/"
        }

        maven {
            allowInsecureProtocol = true

            credentials {
                username = System.getenv("TAOTAO_CLOUD_MAVEN_USERNAME")
                password = System.getenv("TAOTAO_CLOUD_MAVEN_PASSWORD")
            }
            url 'https://repo.rdc.aliyun.com/repository/136936-release-reey0l/'
        }

        mavenCentral()
        google()
        maven { url "https://repo.spring.io/snapshot" }
        maven { url "https://repo.spring.io/milestone" }
        maven { url 'https://repo.spring.io/release' }
        gradlePluginPortal()
    }

    dependencies {
        classpath("org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}")
        classpath 'com.google.protobuf:protobuf-gradle-plugin:0.8.8'
        classpath "gradle.plugin.com.google.cloud.tools:jib-gradle-plugin:3.1.4"
        //classpath 'com.google.protobuf:protobuf-gradle-plugin:0.8.18'
    }
}

plugins {
    id 'java'
    id 'java-library'
    id 'idea'
    id 'signing'
    id 'maven-publish'
    //id 'io.spring.dependency-management' version '1.0.11.RELEASE'
    id "com.google.cloud.tools.jib" version "3.1.4"
    id "com.github.johnrengelman.processes" version "0.5.0"
    id "org.springdoc.openapi-gradle-plugin" version "1.3.0"
    id "com.github.shalousun.smart-doc" version "2.2.8"
    //id "org.jetbrains.intellij" version "0.6.5"
    id "org.owasp.dependencycheck" version "6.5.1"
    //id "com.bmuschko.docker-spring-boot-application" version "7.2.0"

    id "com.github.johnrengelman.shadow" version "7.1.2"
}

allprojects {
    version project.taotaoCloudVersion
    group project.taotaoCloudGroup

    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17

    [compileJava, compileTestJava, javadoc]*.options*.encoding = 'UTF-8'

    repositories {
        mavenLocal()
        mavenCentral()

        maven {
            url "https://repo1.maven.org/maven2"
        }

        maven {
            allowInsecureProtocol = true
            url 'https://maven.aliyun.com/repository/public'
        }

        maven {
            allowInsecureProtocol = true

            credentials {
                username = System.getenv("TAOTAO_CLOUD_MAVEN_USERNAME")
                password = System.getenv("TAOTAO_CLOUD_MAVEN_PASSWORD")
            }
            url 'https://repo.rdc.aliyun.com/repository/136936-release-reey0l/'
        }

        maven {
            allowInsecureProtocol = true

            credentials {
                username = System.getenv("TAOTAO_CLOUD_MAVEN_USERNAME")
                password = System.getenv("TAOTAO_CLOUD_MAVEN_PASSWORD")
            }
            url 'https://repo.rdc.aliyun.com/repository/136936-snapshot-hglDf2/'
        }
        maven { url "https://repo.spring.io/snapshot" }
        maven { url "https://repo.spring.io/milestone" }
        maven { url 'https://repo.spring.io/release' }
    }
}

configure(subprojects.findAll { (it.name != "taotao-cloud-dependencies") }) { project ->
    apply plugin: 'java'
    apply plugin: 'java-library'
    apply plugin: 'idea'
    apply plugin: 'signing'
    //apply plugin: 'checkstyle'
    apply plugin: 'maven-publish'
	apply plugin: 'application'
    apply plugin: 'org.springframework.boot'
    apply plugin: "org.springdoc.openapi-gradle-plugin"
    apply plugin: "com.github.shalousun.smart-doc"
    //apply plugin: 'io.spring.dependency-management'

    apply plugin: "com.google.cloud.tools.jib"

    apply plugin: "com.taotao.cloud.plugin"
    apply plugin: "org.owasp.dependencycheck"

    //apply plugin: "com.bmuschko.docker-spring-boot-application"

    dependencies {
        implementation platform("io.github.shuigedeng:taotao-cloud-dependencies:$taotaoCloudVersion")
    }

        //checkstyle {
    //    project.ext.checkstyleVersion = '8.14'
    //    // The version of the code quality tool to be used.
    //    // The most recent version of Checkstyle can be found at https://github.com/checkstyle/checkstyle/releases
    //    toolVersion = "8.14"
    //    configFile = file("${rootDir}/checkstyle/google_checks.xml")
    //    //configFile = rootProject.file('quality/google_checks.xml')
    //
    //    // The source sets to be analyzed as part of the check and build tasks.
    //    // Use 'sourceSets = []' to remove Checkstyle from the check and build tasks.
    //    // sourceSets = [project.sourceSets.main, project.sourceSets.test]
    //
    //    // Whether or not to allow the build to continue if there are warnings.
    //    ignoreFailures = false
    //
    //    // Whether or not rule violations are to be displayed on the console.
    //    showViolations = true
    //}

    configurations.all {
        resolutionStrategy {
            cacheChangingModulesFor 0, "seconds"
            cacheDynamicVersionsFor 0, "seconds"
        }
    }

    javadoc {
        failOnError false

        options {
            //encoding "UTF-8"
            //charSet 'UTF-8'
            author true
            version true
            title project.name
        }

        options.addStringOption('Xdoclint:none', '-quiet')
        options.addStringOption('encoding', 'UTF-8')
        options.addStringOption('charSet', 'UTF-8')
    }

    task sourcesJar(type: Jar, dependsOn: classes) {
        //from sourceSets.main.allJava
        from sourceSets.main.allSource

        archiveClassifier = 'sources'
    }

    task javadocJar(type: Jar, dependsOn: javadoc) {
        from javadoc
        archiveClassifier = 'javadoc'
    }

    gradle.projectsEvaluated {
        tasks.withType(JavaCompile) {
            options.compilerArgs += [
                    '-Xlint:unchecked',
                    '-Xlint:deprecation',
                    '--add-exports=java.desktop/sun.font=ALL-UNNAMED'
            ]
        }
    }

    /**
     * 该过滤器会导致resource下文件编码错误
     * 根据环境打包默认dev开发环境，命令：./gradlew -x test clean bootJar -Denv=dev
     */
    /*
    def env = System.getProperty("env") ?: "dev"
    processResources {
        filter org.apache.tools.ant.filters.ReplaceTokens, tokens: [env: env]
    }
    */

    tasks.withType(Jar) {
        from(project.rootDir) {
            include 'LICENSE.txt'
            include 'NOTICE.txt'
            into 'META-INF'
        }
    }

    bootJar{
        manifest {
            attributes project.tasks.jar.manifest.attributes
        }
    }

    jar {
        enabled = true
        classifier = null

        manifest {
            attributes (
                    'Implementation-Title': project.name,
                    'Implementation-Version': project.version,
                    'Implementation-Vendor': 'Apache Software Foundation',
                    'Implementation-Vendor-Id': project.group,
                    'Specification-Version': "2022",
                    'Specification-Vendor': 'Apache Software Foundation',
                    'Specification-Title': project.name,
                    'Built-By': 'shuigedeng',
                    'Automatic-Module-Name': project.name.replace("-", "."),
                    'Implementation-URL': "https://github.com/shuigedeng/taotao-cloud-project",
                    'Build-Jdk-Spec': JavaVersion.VERSION_17.toString()
            )
        }
    }

    publishing {
        repositories {
            maven {
                //https://repomanage.rdc.aliyun.com/
                name = "Aliyun"
                if (project.version.endsWith('-SNAPSHOT')) {
                    url = "https://repo.rdc.aliyun.com/repository/136936-snapshot-hglDf2/"
                } else {
                    url = "https://repo.rdc.aliyun.com/repository/136936-release-reey0l/"
                }

                allowInsecureProtocol = true
                credentials {
                    username = findProperty("mavenUsername") ?: System.getenv("TAOTAO_CLOUD_MAVEN_USERNAME")
                    password = findProperty("mavenPassword") ?: System.getenv("TAOTAO_CLOUD_MAVEN_PASSWORD")
                }
            }

            maven {
                name = "GitHub"
                url = uri("https://maven.pkg.github.com/shuigedeng/taotao-cloud-project")
                credentials {
                    username = findProperty("githubUsername") ?: System.getenv("TAOTAO_CLOUD_GITHUB_USERNAME")
                    password = findProperty("githubPassword") ?: System.getenv("TAOTAO_CLOUD_GITHUB_TOKEN")
                }
            }

            maven {
                name = "Sonatype"
                if (project.version.endsWith('-SNAPSHOT')) {
                    url = "https://s01.oss.sonatype.org/content/repositories/snapshots/"
                } else {
                    url = "https://s01.oss.sonatype.org/service/local/staging/deploy/maven2/"
                }
                allowInsecureProtocol = true
                credentials {
                    username = findProperty("ossrhUsername") ?: System.getenv("TAOTAO_CLOUD_OSSRH_USERNAME")
                    password = findProperty("ossrhPassword") ?: System.getenv("TAOTAO_CLOUD_OSSRH_PASSWORD")
                }
            }
        }

        publications {
            mavenJava(MavenPublication) {
                groupId rootProject.group
                artifactId project.name
                version rootProject.version

                //打包类型 war: components.web jar: components.java
                from components.java

                // artifact shadowJar
                artifact sourcesJar
                artifact javadocJar

                pom {
                    name = project.name
                    description = project.name
                    url = 'https://github.com/shuigedeng/taotao-cloud-project.git'

                    licenses {
                        license {
                            name = 'The Apache License, Version 2.0'
                            url = 'http://www.apache.org/licenses/LICENSE-2.0.txt'
                        }
                    }

                    developers {
                        developer {
                            id = 'shuigedeng'
                            name = 'shuigedeng'
                            email = '981376577@qq.com'
                        }
                    }

                    scm {
                        connection = 'scm:git:git@github.com:shuigedeng/taotao-cloud-project.git'
                        developerConnection = 'scm:git:ssh://git@github.com:shuigedeng/taotao-cloud-project.git'
                        url = 'https://github.com/shuigedeng/taotao-cloud-project.git'
                    }
                }
            }
        }
    }

    signing {
        sign publishing.publications.mavenJava
    }
}

configure(subprojects.findAll { (!it.name.startsWith("taotao-cloud-starter")) }) { project ->

    apply plugin: "com.github.johnrengelman.shadow"

    //shadowJar {
    //    manifest {
    //        inheritFrom project.tasks.jar.manifest
    //    }
    //}

    shadowJar {
        zip64 true
        mergeServiceFiles()
        classifier = null
    }

    task createProperties(dependsOn: processResources) {
        doLast {
            def fileDir = new File("$buildDir/resources/main");
            if (fileDir.exists() && fileDir.isDirectory()) {
                def pro = ["application.properties", "bootstrap.properties"]
                pro.forEach(item -> {
                    new File("$buildDir/resources/main/$item").withWriter { w ->
                        def projectProperties = project.properties
                        Properties p = new Properties()
                        projectProperties.each { entry ->
                            p[entry.key.toString()] = entry.value.toString()
                        }

                        p.store w, null
                    }
                })
            }
        }
    }

    classes {
        dependsOn createProperties
    }

//    configurations {
//        all {
//            exclude group: 'log4j', module: 'log4j'
//        }
//    }
}


//configurations.all{
//    resolutionStrategy{
//        //修改gradle不自动处理版本冲突
//        // failOnVersionConflict()
//
//        //手动指定某个jar版本
//        //force 'org.slf4j:slf4j-api:1.7.24'
//    }
//}
//
// gradle生命周期中的钩子方法
//gradle.projectsEvaluated {
//    System.setProperty("version", project.version)
//    System.setProperty("gradleVersion", gradle.gradleVersion)
//
//    project.setProperty("version", project.version)
//}
//
//System.setProperty("version", project.version)
//System.setProperty("gradleVersion", gradle.gradleVersion)
//
//project.setProperty("version", project.version)

//gradle.afterProject {
//    System.setProperty("version", project.version)
//    System.setProperty("gradleVersion", gradle.gradleVersion)
//
//    project.setProperty("version", project.version)
//}

